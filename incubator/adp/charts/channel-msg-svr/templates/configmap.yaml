kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ .Release.Name }}-channel-msg
  namespace: {{ .Release.Namespace }}
data:
  application.yaml: |
    sync_time_out: 1800
    sync_stream_time_out: 5
    msg_menu_text_limit: 45
    msg_menu_item_num_limit: 10
    create_session_words:
      "新建对话": true
    reset_session_words:
      "清除上下文关联": true
    system_msg_err: "【系统消息】内部服务错误，请稍候重试。"
    system_msg_creation_session_success: "【系统消息】以下是新对话。"
    system_msg_creation_session_failed: "【系统消息】新建对话失败，请稍候再试。"
    system_msg_reset_session_success: "【系统消息】已清空上下文关联"
    system_msg_reset_session_failed: "【系统消息】清空上下文关联失败，请稍候再试。"
    channel_type_map:
      wechat: 10000
      wecom: 10002
      wxkf: 10004
      wecomrobot: 10009
    component_app_id: {{ (.Values.global.channelmsgsvr).component_app_id | default "" }}  #微信后台的应用appid   公有云用的自己的，这里需要填用户的
    wx_authorize_callback_host: {{ (.Values.global.channelmsgsvr).wx_authorize_callback_host | default "" }}  #需要填写用户自己申请的域名  需要能反代回到msg服务
    wx_authorize_callback: {{ (.Values.global.channelmsgsvr).wx_authorize_callback | default "" }}
    sse_chat_path: /v1/qbot/chat/sse
    redirect_url: {{ .Values.global.scheme }}://{{ .Values.global.clb }}/lke#/app/knowledge/release/channel?appid=%d&appType=knowledge_qa&spaceId=default_space
    redirect_url_with_space_id: {{ .Values.global.scheme }}://{{ .Values.global.clb }}/lke#/app/knowledge/release/channel?appid=%d&appType=knowledge_qa&spaceId=%s
    get_wx_auth_code_max_limit : 3
    streaming_throttle: 200
    not_support_msg: 暂不支持的消息类型 
    env: lke
    get_ip_max_limit : 2000
    is_open_ip_max_limit_switch : false
    forward_proxy_ip: channelproxysvr.{{ .Release.Namespace }}.svc.cluster.local:8001
    storage_type: {{ .Values.global.components.s3.providerType }}
    yuanqi_api_key: xxxx
    publish_yuanqi_url: /admin_api/v2/agent/publish/yuanqi
    publish_yingyongbao_url: /admin_api/v2/agent/publish/yinyongbao
    cos_secret_id: {{ .Values.global.components.s3.cos.secretId }}
    cos_secret_key: {{ .Values.global.components.s3.cos.secretKey }}
    cos_bucket: {{ .Values.global.components.s3.cos.bucket }}
    cos_region: {{ .Values.global.components.s3.cos.region }}
    wx_nginx_l5: lke_https_forward_proxy
    wx_nginx_namespace: Test
    
    message_interval_time: 800ms
    wechat_msg_time_out: 20m
    deployment_mode:
      mode: "adp"
    # 默认欢迎语
    default_greeting_content: 可以这样问我：
    # 未认证公众号回复配置
    uncertified_wx_reply_config:
      uncertified_reply_in_5s_wx_app_ids:
      continue_keywords:
        - "继续"
        - "继续。"
        - "【继续】"
        - "请继续"
        - "继续发"
      no_reply_notice: "正在思考中……可回复【继续】获取回答内容" # 5s 或 15s未回复提示
      reply_not_complete_notice: "回答未完成，可回复【继续】获取更多回答内容" # 回答未完成提示
      discard_continue_notice: "模型正在思考中，请稍后回复【继续】获取更多回答内容" # 忽略继续关键词通知
    
  channel-msg_en-US.json: |
    {}
  channel-msg_zh-CN.json: |
    {}
  error_en-US.json: |
    {
      "参数错误": "Invalid Parameter",
      "get请求签名校验错误": "Get Request Signature Verification Error",
      "GetAgentInfo fail": "Get Agent Info Fail",
      "请求签名校验错误": "Request Signature Verification Error",
      "解密后参数解析错误": "Decrypted Parameter Parsing Error",
      "get msg_provider failed, need register plugins": "Failed to get msg_provider, need to register plugins",
      "unknown http method": "Unknown Http Method",
      "no data available": "No Data Available",
      "wxPub c2b msg type not support": "Wx Pub C2B Msg Type Not Support",
      "公众号已被当前应用绑定，请先解绑后再操作": "Public Account Already Bound Please Unbind First",
      "wx pub request url parse error": "Wechat Pub request URL parse error",
      "wx pub request url not include appid": "Wx Pub Request Url Not Include Appid",
      "wxPub b2c call wx failed": "Wechat Pub B2C Call Wechat Failed",
      "wxPub c2b xml parse error": "Wx Pub C2B Xml Parse Error",
      "wx auth code is empty": "Wechat auth code is empty",
      "appBiz id is empty": "App Biz Id Is Empty",
      "call wx get pre auth code failed": "Call Wx Get Pre Auth Code Failed",
      "达到每分钟最大授权次数，请稍后再试": "Reached Max Auth Limit Per Minute, Please Try Later",
      "call wecom send msg failed": "Call Wecom Send Msg Failed",
      "ai response body is empty": "AI Response body is empty",
      "msg id duplication has been intercepted": "Msg Id Duplication Has Been Intercepted",
      "input cos uuid is intercepted": "Input Cos Uuid Is Intercepted",
      "down data format error": "Down Data Format Error",
      "env环境未注册": "Env Environment Not Registered",
      "syncType传参错误": "Sync Type Parameter Error",
      "修改渠道状态处理失败": "Failed to process channel status modification",
      "获取公众号关联的应用信息失败": "Failed to get associated info for official account",
      "获取公众号渠道信息失败": "Get Public Account Channel Info Failed",
      "获取渠道信息失败": "Get Channel Info Failed",
      "检查渠道发布状态失败": "Failed to check channel release status",
      "获取元器配置失败": "Get Yuan Config Failed",
      "c2b pull wxkf msg failed": "C2B Pull Wxkf Msg Failed",
      "c2b wxkf msg event not support": "C2B Wxkf Msg Event Not Support",
      "消息发送失败，系统错误": "Message sending failed, system error",
      "wxkf set next cursor failed": "Wxkf Set Next Cursor Failed",
      "wxkf get cursor failed": "Wxkf Get Cursor Failed",
      "wxkf send msg finish": "Failed to send message to Wechat Customer Service",
      "wxkf info no data available": "No Wechat Customer Service data available",
      "拉取微信客服形象失败，确认已经开通微信客服": "Failed to call Wechat Customer Service, Please confirm it's enabled",
      "无效的企业ID或Secret，请确认填写是否正确": "Invalid Corp Id Or Secret, Please Confirm if Correct",
      "get wxkf id info failed": "Failed to get Wechat Customer Service Info",
      "get corp id from ctx failed": "Get Corp Id From Ctx Failed",
      "没有可操作的渠道": "No Operable Channel Available",
      "发送失败:微信暂不支持该文件类型": "Sending failed: WeChat currently does not support this file type",
      "发送失败:素材超过微信最大10MB限制": "Sending failed: Material exceeds the max 10MB limit for wechat",
      "不合法的媒体文件id": "Invalid Media File Id"
    }
  error_zh-CN.json: |
    {
      "参数错误": "参数错误",
      "get请求签名校验错误": "get请求签名校验错误",
      "GetAgentInfo fail": "GetAgentInfo fail",
      "请求签名校验错误": "请求签名校验错误",
      "解密后参数解析错误": "解密后参数解析错误",
      "get msg_provider failed, need register plugins": "get msg_provider failed, need register plugins",
      "unknown http method": "unknown http method",
      "no data available": "no data available",
      "wxPub c2b msg type not support": "wxPub c2b msg type not support",
      "公众号已被当前应用绑定，请先解绑后再操作": "公众号已被当前应用绑定，请先解绑后再操作",
      "wx pub request url parse error": "wx pub request url parse error",
      "wx pub request url not include appid": "wx pub request url not include appid",
      "wxPub b2c call wx failed": "wxPub b2c call wx failed",
      "wxPub c2b xml parse error": "wxPub c2b xml parse error",
      "wx auth code is empty": "wx auth code is empty",
      "appBiz id is empty": "appBiz id is empty",
      "call wx get pre auth code failed": "call wx get pre auth code failed",
      "达到每分钟最大授权次数，请稍后再试": "达到每分钟最大授权次数，请稍后再试",
      "call wecom send msg failed": "call wecom send msg failed",
      "ai response body is empty": "ai response body is empty",
      "msg id duplication has been intercepted": "msg id duplication has been intercepted",
      "input cos uuid is intercepted": "input cos uuid is intercepted",
      "down data format error": "down data format error",
      "env环境未注册": "env环境未注册",
      "syncType传参错误": "syncType传参错误",
      "修改渠道状态处理失败": "修改渠道状态处理失败",
      "获取公众号关联的应用信息失败": "获取公众号关联的应用信息失败",
      "获取公众号渠道信息失败": "获取公众号渠道信息失败",
      "获取渠道信息失败": "获取渠道信息失败",
      "检查渠道发布状态失败": "检查渠道发布状态失败",
      "获取元器配置失败": "获取元器配置失败",
      "c2b pull wxkf msg failed": "c2b pull wxkf msg failed",
      "c2b wxkf msg event not support": "c2b wxkf msg event not support",
      "消息发送失败，系统错误": "消息发送失败，系统错误",
      "wxkf set next cursor failed": "wxkf set next cursor failed",
      "wxkf get cursor failed": "wxkf get cursor failed",
      "wxkf send msg finish": "wxkf send msg finish",
      "wxkf info no data available": "wxkf info no data available",
      "拉取微信客服形象失败，确认已经开通微信客服": "拉取微信客服形象失败，确认已经开通微信客服",
      "无效的企业ID或Secret，请确认填写是否正确": "无效的企业ID或Secret，请确认填写是否正确",
      "get wxkf id info failed": "get wxkf id info failed",
      "get corp id from ctx failed": "get corp id from ctx failed",
      "没有可操作的渠道": "没有可操作的渠道",
      "发送失败:微信暂不支持该文件类型": "发送失败:微信暂不支持该文件类型",
      "发送失败:素材超过微信最大10MB限制": "发送失败:素材超过微信最大10MB限制",
      "不合法的媒体文件id": "不合法的媒体文件id"
    }
  trpc_go.yaml: |
    global:                             #全局配置
      namespace: ${NAME_SPACE}             #环境类型，分正式production和非正式development两种类型
      env_name: dev                    #环境名称，非正式环境下多环境的名称
      enable_set: ${ENABLE_SET}         #是否启用set
      full_set_name: ${FULL_SET_NAME}   #set名
      local_ip: ${POD_IP}
      container_name: ${POD_NAME}
    
    server:                                            #服务端配置
      app: KEP                                        #业务的应用名
      server: channel-msg-svr                         #进程服务名
      bin_path: /usr/local/trpc/bin/                   #二进制可执行文件和框架配置文件所在路径
      conf_path: /usr/local/trpc/conf/                 #业务配置文件所在路径
      data_path: /usr/local/trpc/data/                 #业务数据文件所在路径
      filter:                                          #针对所有service处理函数前后的拦截器列表
        - recovery                                     #拦截框架创建的业务处理协程panic
        - galileo
        - i18n-adp
      admin:
        ip: ${POD_IP}
        port: 8081
      service:                                         #业务服务提供的service，可以有多个
        - name: trpc.KEP.channel-msg-svr.HTTP      #service的路由名称
          ip: ${POD_IP}                            #服务监听ip地址 可使用占位符 ${ip},ip和nic二选一，优先ip
          #nic: eth0
          port: 8000                #服务监听端口 可使用占位符 ${port}
          network: tcp                             #网络监听类型  tcp udp
          protocol: http_no_protocol               #应用层协议 trpc http
          timeout: 50000                            #请求最长处理时间 单位 毫秒
          server_async: true                           #开启异步处理
          idletime: 600000                             # idletime，设置tcp空闲等待时间，避免耗时过长的操作导致trpc-go将tcp关闭
        - name: trpc.KEP.channel-msg-svr.trpc    #service的路由名称
          ip: ${POD_IP}                            #服务监听ip地址 可使用占位符 ${ip},ip和nic二选一，优先ip
          #nic: eth0
          port: 8001                #服务监听端口 可使用占位符 ${port}
          network: tcp                             #网络监听类型  tcp udp
          protocol: trpc               #应用层协议 trpc http
          timeout: 50000                           #请求最长处理时间 单位 毫秒
          server_async: true                           #开启异步处理
          idletime: 600000                             # idletime，设置tcp空闲等待时间，避免耗时过长的操作导致trpc-go将tcp关闭
        - name: trpc.KEP.trpc.KEP.channel-msg-svr.Api    #service的路由名称
          ip: ${POD_IP}                            #服务监听ip地址 可使用占位符 ${ip},ip和nic二选一，优先ip
          #nic: eth0
          port: 8002                #服务监听端口 可使用占位符 ${port}
          network: tcp                             #网络监听类型  tcp udp
          protocol: trpc               #应用层协议 trpc http
          timeout: 50000                           #请求最长处理时间 单位 毫秒
          server_async: true                           #开启异步处理
          idletime: 600000                             # idletime，设置tcp空闲等待时间，避免耗时过长的操作导致trpc-go将tcp关闭
    plugins:                                          #插件配置
      config:
        file:
          providers:
            - name: rainbow
              path: /app/conf/
      telemetry:
        galileo:
          verbose: error   # 伽利略自身的诊断日志级别，取值范围：debug, info, error, none，日志输出在 ./galileo/galileo.log 中。
          config: #配置
            metrics_config: # 指标配置
              enable: true    # 是否启用指标
            traces_config: # 追踪配置
              enable: true    # 是否启用追踪，默认 true。如果设置为 false，会中断 trace，让上游的调用链不完整。v0.3.7 以上生效。
              processor: # 追踪数据处理相关配置
                sampler: # 采样器配置
                  fraction: 1   # 采样比例，默认 0。（v0.11.0)
                  server:
                    fraction: 0.1
                  error_fraction: 1
                  enable_min_sample: true  # 启用每分钟每接口最少 1 个请求采样，默认 true (v0.11.0)。
                  enable_dyeing: true # 开启染色采样，默认 true。
                disable_trace_body: false          # 若为 true，则关闭 trace 中对 req 和 rsp 的 body 上报，可以大幅提高上报性能。默认 true。
                enable_deferred_sample: false     # 开启延迟采样（请求处理完采样），默认 false。0.3.0 以上生效。
                deferred_sample_error: false      # 开启延迟采样出错采样（请求处理完出现错误采样），默认 false。0.3.0 以上生效。
                deferred_sample_slow_duration_ms: 1000    # 慢操作阈值（请求耗时超过该值采样），单位 ms，默认 1000。0.3.0 以上生效。
                disable_parent_sampling: false            # 忽略上游的采样结果，默认 false。v0.3.7 以上生效。
            logs_config: # 日志配置
              enable: true    # 是否启用日志
              processor: # 日志数据处理相关配置
                only_trace_log: false  # 是否只上报命中 trace 的 log，默认关闭
                must_log_traced: false # 是否命中 traced 不管任何级别日志都上报，默认关闭。v0.3.22 以上生效,trpc-go v0.16 版本及以上不生效,必须将 writer 的日志级别设置为 debug
                trace_log_mode: 0   # debug 访问日志 (access_log) 打印模式，0不打印， 1：单行打印，3：多行打印，2：不打印，默认 0
                level: debug        # 上报到远程的日志级别，默认 error
                enable_recovery: true # 是否捕获 panic，默认 true
            profiles_config:    # profile配置
              enable: true # 是否启用 profile
              processor: # profile 数据处理相关配置
                profile_types: ["cpu", "heap"] # 采集 profile 的类型，支持 cpu、heap、mutex、block、goroutine，默认开启 cpu 和 heap。
            version: 1        # 版本号，默认 0，此版本号用于控制远程配置和本地配置的优先级，版本号高的优先，一般设置成 1 即可。
          resource: # resource 资源信息，在 SDK 运行期间不会改变。resource 中的字段一般不需要配置，默认会填充。
            platform: STKE   # 服务部署的平台，如 PCG-123, STKE, 默认 PCG-123
      log:                                            #日志配置
        default:                                      #默认日志的配置，可支持多输出
          - writer: console                           #控制台标准输出 默认
            level: debug                              #标准输出日志的级别
          - writer: file                              #本地文件日志
            level: info                               #本地文件滚动日志的级别
            writer_config:
              filename: /usr/local/trpc/log/trpc.log    #本地文件滚动日志存放的路径
              max_size: 10                              #本地文件滚动日志的大小 单位 MB
              max_backups: 10                           #最大日志文件数
              max_age: 7                                #最大日志保留天数
              compress:  false                          #日志文件是否压缩
      registry: #服务注册配置
        polaris: #北极星名字注册服务的配置
          register_self: false
          heartbeat_interval: 3000                    #名字注册服务心跳上报间隔
          heartbeat_timeout: 1000                     #名字服务心跳超时
          service:
            - name: trpc.KEP.channel-msg-svr.HTTP    #service name 与上面的service配置一一对应
              namespace: ${NAME_SPACE}              #环境类型，分正式Production和非正式Development两种类型
              token: d8b87889e517410e9a963c191f378d09             #服务注册所需要的 token
            - name: trpc.KEP.channel-msg-svr.trpc    #service name 与上面的service配置一一对应
              namespace: ${NAME_SPACE}              #环境类型，分正式Production和非正式Development两种类型
              token: 34c9fa7d88974ac09189c928a7cb6fe2             #服务注册所需要的 token
            - name: trpc.KEP.trpc.KEP.channel-msg-svr.Api    #service name 与上面的service配置一一对应
              namespace: ${NAME_SPACE}              #环境类型，分正式Production和非正式Development两种类型
              token: a294ef928f0648a3989999fe5186aa3a             #服务注册所需要的 token
      i18n:
        i18n-adp:
          default_lang: zh-CN
          supported_languages:   # [可选]: 系统支持的语言列表。默认值 支持系统默认语言
            - zh-CN
            - en-US
          data_provider:
            type: rainbow
            prefix: channel-msg
            error_prefix: error
            char_scaling_factor: # [可选]: 字符数扩展倍数。默认 zh-CN: 1; en-US: 3
              zh-CN: 1
              en-US: 3
    client:
      service:
        - name: mysql.qbot.admin
          target: dsn://{{ .Values.global.components.db.user }}:{{ .Values.global.components.db.password }}@tcp({{ .Values.global.components.db.host }}:{{ .Values.global.components.db.port }})/db_llm_robot?charset=utf8mb4&timeout=1s&parseTime=true&interpolateParams=true&loc=Local
        - name: tdsql.tcadp.channel
          target: dsn://{{ .Values.global.components.db.user }}:{{ .Values.global.components.db.password }}@tcp({{ .Values.global.components.db.host }}:{{ .Values.global.components.db.port }})/db_llm_robot?charset=utf8mb4&timeout=1s&parseTime=true&interpolateParams=true&loc=Local
        - name: redis.qbot.admin
          network: tcp
          target: ip://{{ (index .Values.global.components.redis.hosts 0) }}:6379/1
          password: "{{ .Values.global.components.redis.password }}"
          timeout: 800
        - name: wx.nginx   #---------nginx出口-------------
          target: ip://channelproxysvr.{{ .Release.Namespace }}.svc.cluster.local:8001
          network: tcp
          protocol: http
          timeout: 20000
        - name: wx.resource.nginx   #---------nginx出口-------------
          target: ip://channelproxysvr.{{ .Release.Namespace }}.svc.cluster.local:8001
          network: tcp
          protocol: http
          timeout: 20000
        - name: trpc.KEP.channel_token_svr.ChannelTokenService
          network: tcp
          protocol: trpc
          target: ip://channeltokensvr.{{ .Release.Namespace }}.svc.cluster.local:8000
          timeout: 2000
        - name: trpc.KEP.channel_resource_convert_svr.ResourceManagerService
          network: tcp
          protocol: trpc
          target: ip://channelresourceconvertsvr.{{ .Release.Namespace }}.svc.cluster.local:8000
          timeout: 5000 
        - name: trpc.KEP.bot_admin_config_server.Admin
          network: tcp
          protocol: trpc
          target: ip://admin.{{ .Release.Namespace }}.svc.cluster.local:9090
          timeout: 5000 
        - callee: trpc.ai.client
          name: trpc.ai.client
          network: tcp
          protocol: http
          target: dns://{{ .Values.global.clb }}:80
          timeout: 600000
        - callee: trpc.KEP.bot_admin_config_server.Login
          target: ip://admin.{{ .Release.Namespace }}.svc.cluster.local:9091
          protocol: trpc
          timeout: 20000
        - callee: trpc.KEP.bot_admin_config_server.Api
          target: ip://admin.{{ .Release.Namespace }}.svc.cluster.local:9092
          protocol: trpc
          timeout: 20000
        - name: trpc.KEP.bot_task_config_server.TaskConfig
          target: ip://bottaskconfigserver.{{ .Release.Namespace }}.svc.cluster.local:8000
          timeout: 5000 
        - callee: trpc.KEP.bot_knowledge_config_server.Api
          name: trpc.KEP.bot-knowledge-config-server.Api
          target: ip://botknowledgeconfigserver.{{ .Release.Namespace }}.svc.cluster.local:9092
          protocol: trpc
          timeout: 5000
        # admin Login
        - callee: trpc.adp.app_admin_proxy.Login
          target: ip://admin.{{ .Release.Namespace }}.svc.cluster.local:9091
          protocol: trpc
          timeout: 20000
        # admin API
        - callee: trpc.adp.app_admin_proxy.Api
          target: ip://admin.{{ .Release.Namespace }}.svc.cluster.local:9092
          protocol: trpc
          timeout: 20000
        # 工作流配置端-内部接口
        - callee: trpc.adp.workflow_config.WorkflowConfig
          target: ip://bottaskconfigserver.{{ .Release.Namespace }}.svc.cluster.local:8000
          timeout: 5000
        # 知识库-内部接口
        - callee: trpc.adp.kb_config.Api
          name: trpc.KEP.bot-knowledge-config-server.Api
          target: ip://botknowledgeconfigserver.{{ .Release.Namespace }}.svc.cluster.local:9092
          protocol: trpc
          timeout: 5000
        - callee: trpc.KEP.bot_chat_server.Chat
          name: trpc.KEP.bot_chat_server.Chat
          target: ip://chat.{{ .Release.Namespace }}.svc.cluster.local:9091 
          protocol: trpc
          timeout: 20000
