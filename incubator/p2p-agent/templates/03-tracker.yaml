{{- if ne .Values.global.deployMode "leecher" }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tracker
  namespace: {{ .Values.global.namespace }}
spec:
  replicas: {{ .Values.tracker.replicaCount }}
  selector:
    matchLabels:
      app: tracker
  template:
    metadata:
      labels:
        app: tracker
    spec:
      containers:
        - name: tracker
          image: "{{ .Values.images.tracker.image }}:{{ .Values.images.tracker.tag }}"
          imagePullPolicy: {{ .Values.global.imagePullPolicy }}
          # command: ["/bin/bash", "-c", "sleep 1234"]
          ports:
            - containerPort: {{ .Values.tracker.port }}
          env:
            - name: LOG_IS_DEBUG
              value: {{.Values.tracker.debug | quote }}
          volumeMounts:
            - name: config-volume
              mountPath: /app/config
      volumes:
        - name: config-volume
          configMap: 
            name: tracker-config
---
apiVersion: v1
kind: Service
metadata:
  name: tracker-service
  namespace: {{ .Values.global.namespace }}
spec:
  type: NodePort
  selector:
    app: tracker
  ports:
    - port: 80
      targetPort: {{ .Values.tracker.port }}
      nodePort: {{ .Values.tracker.nodePort }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tracker-config
  namespace: {{ .Values.global.namespace }}
data:
  trpc_go.yaml: |
    global:
      namespace: Development
      env_name: test
    server:
      app: tracker
      server: cmd
      bin_path: /app
      conf_path: /app/config
      data_path: /app/tracker
      admin:
        ip: 127.0.0.1
        port: 18945
        read_timeout: 3000
        write_timeout: 60000
      service:
        - network: tcp
          protocol: http_no_protocol
          timeout: 1000
          ip: 0.0.0.0
          port: {{ .Values.tracker.port }}
    plugins:
      log:
        default:
          - writer: file
            level: info
            writer_config:
              log_path: /app/tracker
              filename: trpc.log
              roll_type: size
              max_age: 7
              max_size: 10
              max_backups: 10
              compress: false
  tracker.yaml: |
    chihaya:
      announce_interval: 60m
      min_announce_interval: 30m
      metrics_addr: {{ .Values.tracker.chihayaMetricsAddr }}
      http:
        addr: {{ .Values.tracker.chihayaServiceAddr }}
        read_timeout: 5s
        write_timeout: 5s
        enable_keepalive: false
        idle_timeout: 30s
        enable_request_timing: false
        announce_routes:
          - "/announce"
        scrape_routes:
          - "/scrape"
        allow_ip_spoofing: true
        real_ip_header: "x-real-ip"
        max_numwant: 100
        default_numwant: 60
        max_scrape_infohashes: 60
      udp:
        addr: {{ .Values.tracker.chihayaServiceAddr }}
        max_clock_skew: 10s
        private_key: "lucky"
        enable_request_timing: false
        allow_ip_spoofing: false
        max_numwant: 100
        default_numwant: 50
        max_scrape_infohashes: 50
      storage:
        name: {{ .Values.tracker.storageName }}
        config:
          gc_interval: 3m
          peer_lifetime: 61m
          shard_count: 1024
          prometheus_reporting_interval: 1s
          redis_broker: "{{ .Values.tracker.storageRedis }}"
          redis_read_timeout: 5s
          redis_write_timeout: 5s
          redis_connect_timeout: 5s
          redis_cluster_broker: "{{ .Values.tracker.storageRedis }}"
          redis_cluster_read_timeout: 5s
          redis_cluster_write_timeout: 5s
          redis_cluster_connect_timeout: 5s
      peerpolicy:
        selector:
          name: default
          config:
        default_policy: all
        policies:
          - name: all
            config:
{{- end }}
