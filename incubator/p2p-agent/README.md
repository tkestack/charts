# P2P Agent Helm Chart

P2P Agent æ˜¯ä¸€ä¸ªå®¹å™¨é•œåƒåŠ é€Ÿç³»ç»Ÿï¼Œé€šè¿‡ P2P æŠ€æœ¯åŠ é€Ÿå®¹å™¨é•œåƒåˆ†å‘ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿéƒ¨ç½²åº”ç”¨ï¼Œæ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼ã€‚é€šè¿‡ P2P Agent åŠ é€Ÿï¼Œå¯ä»¥è®© 50GB é•œåƒç«¯åˆ°ç«¯æ‹‰å–è€—æ—¶ï¼Œä»Ž 10 åˆ†é’Ÿé™åˆ° 5 åˆ†é’Ÿï¼Œåˆ†å‘æ€§èƒ½æå‡ 100%ã€‚

## ðŸš€ åŠŸèƒ½ç‰¹æ€§

- **P2P é•œåƒåˆ†å‘**: åŸºäºŽ BitTorrent åè®®çš„é•œåƒåˆ†å‘
- **è‡ªåŠ¨æ•…éšœæ¢å¤**: æ”¯æŒèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨æ¢å¤å’Œè´Ÿè½½å‡è¡¡
- **å¤šéƒ¨ç½²æ¨¡å¼**: æ”¯æŒSeederã€Leecherã€Mixedä¸‰ç§éƒ¨ç½²æ¨¡å¼
- **ç›‘æŽ§å‘Šè­¦**: å†…ç½®Prometheusç›‘æŽ§æŒ‡æ ‡
- **é•œåƒé¢„çƒ­**: æ”¯æŒä¸»åŠ¨é•œåƒé¢„çƒ­åŠŸèƒ½ï¼ˆè…¾è®¯å†…éƒ¨åŠŸèƒ½ï¼ŒTCR æš‚ä¸æ”¯æŒï¼‰
- **èƒ–ç˜¦åˆ†ç¦»**: æ”¯æŒèƒ–ç˜¦åˆ†ç¦»éƒ¨ç½²ï¼Œç˜¦èŠ‚ç‚¹ä»…é€šè¿‡ leecher æ¨¡å¼éƒ¨ç½² Agent ç»„ä»¶ï¼Œé™ä½Žèµ„æºå ç”¨

## åœºæ™¯ä¸Žéƒ¨ç½²æ¨¡å¼

### ðŸš€ æŽ¨èéƒ¨ç½²æ¨¡å¼ï¼šMixed æ¨¡å¼

æˆ‘ä»¬é¦–å…ˆæŽ¨èä½¿ç”¨ **Mixed æ¨¡å¼**ï¼Œè¿™æ˜¯æœ€é€šç”¨ä¸”é«˜æ•ˆçš„éƒ¨ç½²æ–¹æ¡ˆï¼š

- **é€‚ç”¨åœºæ™¯**: é€‚ç”¨äºŽç»å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯å•é›†ç¾¤å†…çš„é•œåƒåŠ é€Ÿéœ€æ±‚
- **æ ¸å¿ƒä¼˜åŠ¿**: åŠŸèƒ½å®Œæ•´ã€éƒ¨ç½²ç®€å•ã€ç½‘ç»œå»¶è¿Ÿæœ€ä½Ž
- **éƒ¨ç½²æ–¹å¼**: åœ¨åŒä¸€é›†ç¾¤å†…æ ¹æ®èŠ‚ç‚¹è§’è‰²éƒ¨ç½²ä¸åŒç»„ä»¶ï¼Œé«˜æ€§èƒ½èŠ‚ç‚¹éƒ¨ç½² Seeder å’Œ Trackerï¼Œä¸šåŠ¡èŠ‚ç‚¹éƒ¨ç½² Agent
- **èµ„æºä¼˜åŒ–**: é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾çµæ´»åˆ†é…èµ„æºï¼Œæ—¢ä¿è¯åŠ é€Ÿæ•ˆæžœåˆä¸å½±å“ä¸šåŠ¡æ€§èƒ½

### ðŸŽ¯ åœºæ™¯é€‰æ‹©æŒ‡å—

- **ðŸš€ é€šç”¨åœºæ™¯** â†’ **Mixed æ¨¡å¼**ï¼šåŠŸèƒ½å®Œæ•´ï¼Œæ–¹ä¾¿ä½¿ç”¨ï¼Œæœ€å°åŒ–é…ç½®å¿«é€Ÿéƒ¨ç½²
- **ðŸ’¡ èµ„æºæ•æ„Ÿé›†ç¾¤** â†’ **Mixed æ¨¡å¼**ï¼šé«˜æ€§èƒ½èŠ‚ç‚¹éƒ¨ç½² Seederï¼Œä¸šåŠ¡èŠ‚ç‚¹åªéƒ¨ç½² Leecher
- **ðŸ¢ å¤šé›†ç¾¤åŠ é€Ÿ** â†’ **Seeder+Leecher æ¨¡å¼**ï¼šé›†ä¸­ç®¡ç†ï¼Œæˆæœ¬æ•ˆç›Šæœ€é«˜

### ðŸ“Š éƒ¨ç½²æ¨¡å¼å®Œæ•´å¯¹æ¯”

| ç‰¹æ€§/åœºæ™¯ | **Mixed æ¨¡å¼** ðŸš€ | **Leecher æ¨¡å¼** | **Seeder æ¨¡å¼** |
|-----------|-------------------|------------------|----------------|
| **ç»„ä»¶æž„æˆ** | Agent + Tracker + SeedServer | ä»… Agent(Leecher) | Agentï¼ˆSeederï¼‰ + Tracker + SeedServer |
| **ç›®æ ‡ç”¨æˆ·** | å•ä¸ªä¸šåŠ¡é›†ç¾¤ | å·²æœ‰ Seeder é›†ç¾¤ | å¤šä¸ªä¸šåŠ¡é›†ç¾¤ |
| **èµ„æºéœ€æ±‚** | ä¸­ï¼ˆæŒ‰èŠ‚ç‚¹ç±»åž‹åˆ†é…ï¼‰ | ä½Žï¼ˆä»… Agentï¼‰ | é«˜ï¼ˆå…¨å¥—ç»„ä»¶ï¼‰ |
| **ç½‘ç»œå»¶è¿Ÿ** | é›†ç¾¤å†…ï¼ˆæœ€ä½Žï¼‰ | è·¨é›†ç¾¤ï¼ˆè¾ƒé«˜ï¼‰ | è·¨é›†ç¾¤ï¼ˆè¾ƒé«˜ï¼‰ |
| **éƒ¨ç½²å¤æ‚åº¦** | å¤æ‚ | ç®€å• | ä¸­ç­‰ |
| **é€‚ç”¨è§„æ¨¡** | ä¸­å¤§è§„æ¨¡ã€å•é›†ç¾¤ | å°è§„æ¨¡ã€èµ„æºæ•æ„Ÿ | å¤§è§„æ¨¡ã€å¤šé›†ç¾¤ |
| **æŽ¨èåœºæ™¯** | **é»˜è®¤æŽ¨èæ–¹æ¡ˆ** | å·²æœ‰ Seeder é›†ç¾¤ | é›†ä¸­å¼åŠ é€ŸæœåŠ¡ |


## ðŸ—ï¸ æž¶æž„æ¦‚è§ˆ

P2P Agent ç³»ç»ŸåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   P2P Agent     â”‚    â”‚     Tracker     â”‚    â”‚   Seed Server   â”‚
â”‚   (DaemonSet)   â”‚â—„â”€â”€â–ºâ”‚   (Deployment)  â”‚â—„â”€â”€â–ºâ”‚  (Deployment)   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ HTTP Server   â”‚    â”‚ â€¢ Peer Discoveryâ”‚    â”‚ â€¢ Metadata Mgmt â”‚
â”‚ â€¢ Metrics       â”‚    â”‚ â€¢ Load Balance  â”‚    â”‚ â€¢ File Storage  â”‚
â”‚ â€¢ P2P Client    â”‚    â”‚ â€¢ Config API    â”‚    â”‚ â€¢ Object Gatewayâ”‚
â”‚                 â”‚    â”‚ â€¢ Metrics       â”‚    â”‚ â€¢ Seed Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Optional      â”‚
                    â”‚   Components    â”‚
                    â”‚                 â”‚
                    â”‚ â€¢ Watcher       â”‚
                    â”‚ â€¢ S3/Redis      â”‚
                    â”‚ â€¢ Monitor       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Tracker**ï¼šè´Ÿè´£ç®¡ç† P2P Agent çš„è¿žæŽ¥å’Œè´Ÿè½½å‡è¡¡ã€‚
- **SeedServer**ï¼šè´Ÿè´£ç®¡ç† P2P Agent çš„ç§å­æ–‡ä»¶å’Œå­˜å‚¨ã€‚
- **P2P Agent**ï¼šè¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£ä¸Ž Tracker å’Œ SeedServer é€šä¿¡ï¼Œç›‘å¬ 65001 ç«¯å£ï¼Œé€šè¿‡å®¹å™¨è¿è¡Œæ—¶çš„ mirrors é…ç½®ä¸ºèŠ‚ç‚¹æä¾› P2P åŠ é€Ÿç½‘ç»œã€‚æ ¹æ®èŠ‚ç‚¹æ ‡ç­¾è‡ªåŠ¨é€‰æ‹© seeder æˆ– leecher å·¥ä½œæ¨¡å¼ã€‚

## ðŸŽ¯ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

- Helm 3.0+
- Kubernetes 1.18+

### å®‰è£…

1. **åˆ›å»ºå‘½åç©ºé—´**
   ```bash
   kubectl create namespace p2pagent
   ```

2. **å®‰è£… Chart**
   ```bash
   # ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆéœ€è¦é…ç½®å¿…è¦å‚æ•°ï¼‰
   cat > custom-values.yaml << EOF
   # é…ç½®æ”¯æŒçš„é•œåƒä»“åº“ ï¼ˆâš ï¸ è¯·é…ç½®ä¸ºæ‚¨å®žé™…çš„ TCR ä»“åº“åœ°å€ï¼Œéœ€è¦æ˜¯åŒåœ°åŸŸå®žä¾‹ï¼‰
   agent:
     registryHttps: "p2p-bj.tencentcloudcr.com"

   # é…ç½® Tracker å­˜å‚¨ï¼ˆä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œç”Ÿäº§çŽ¯å¢ƒå»ºè®®ä½¿ç”¨ Redisï¼‰
   tracker:
     storageName: "memory"

   # é…ç½® SeedServer å­˜å‚¨ä¿¡æ¯ï¼ˆâš ï¸ è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®žé™… COS å­˜å‚¨é…ç½®ï¼‰
   seedServer:
     cosUrl: "https://your-bucket-id.cos.region.myqcloud.com"  # æ›¿æ¢ä¸ºæ‚¨çš„ COS æ¡¶åœ°å€
     cosId: "your-access-key-id"  # æ›¿æ¢ä¸ºæ‚¨çš„ COS AK
     cosKey: "your-access-key-secret"  # æ›¿æ¢ä¸ºæ‚¨çš„ COS SK
   EOF

   helm install p2p-agent ./incubator/p2p-agent -n p2pagent -f custom-values.yaml --create-namespace

   ```

3. **éªŒè¯å®‰è£…**
   ```bash
   kubectl get pods -n p2pagent
   kubectl get services -n p2pagent
   ```

### å¿«é€Ÿæµ‹è¯•

```bash
# é…ç½®å®¹å™¨è¿è¡Œæ—¶ mirrorsï¼ˆæµ‹è¯•èŠ‚ç‚¹ï¼‰
# å¯¹äºŽ containerd 1.6.9 ç‰ˆæœ¬
# å¤‡ä»½åŽŸå§‹é…ç½®æ–‡ä»¶
cp /etc/containerd/config.toml /etc/containerd/config.toml.bak
# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ é•œåƒä»“åº“é…ç½®
# âš ï¸ ä»¥ p2p-bj.tencentcloudcr.com ä¸ºä¾‹ï¼Œä¿®æ”¹ä¸ºæ‚¨çš„å®žé™… TCR ä»“åº“åœ°å€
cat << EOF | sudo tee /etc/containerd/config.toml
[plugins."io.containerd.grpc.v1.cri".registry]
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors."p2p-bj.tencentcloudcr.com"]
      endpoint = ["http://127.0.0.1:65001"]
EOF

sudo systemctl restart containerd

# å¯¹äºŽ Docker
sudo mkdir -p /etc/docker
cat << EOF | sudo tee /etc/docker/daemon.json
{
  "registry-mirrors": ["http://127.0.0.1:65001"]
}
EOF

sudo systemctl restart docker

# æ‹‰å–é•œåƒæµ‹è¯•
# æ³¨æ„ï¼šè¯·å°†ä¸‹é¢çš„é•œåƒåœ°å€æ›¿æ¢ä¸ºæ‚¨å®žé™…çš„ TCR ä»“åº“åœ°å€
docker pull p2p-bj.tencentcloudcr.com/kofj/httpbin:latest
# æˆ–
crictl pull p2p-bj.tencentcloudcr.com/kofj/httpbin:latest
```

è¯¦ç»†é…ç½®æ¸…å•ï¼Œè¯·å‚è€ƒ [VALUES.md](./VALUES.md)ã€‚
